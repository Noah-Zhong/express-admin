(()=>{var e={500:(e,s,t)=>{var r=t(837),o=t(491);function n(){return(new Date).getTime()}var u,a=Array.prototype.slice,i={};u="undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{};for(var l=[[function(){},"log"],[function(){u.log.apply(u,arguments)},"info"],[function(){u.log.apply(u,arguments)},"warn"],[function(){u.warn.apply(u,arguments)},"error"],[function(e){i[e]=n()},"time"],[function(e){var s=i[e];if(!s)throw new Error("No such label: "+e);delete i[e];var t=n()-s;u.log(e+": "+t+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=r.format.apply(null,arguments),u.error(e.stack)},"trace"],[function(e){u.log(r.inspect(e)+"\n")},"dir"],[function(e){if(!e){var s=a.call(arguments,1);o.ok(!1,r.format.apply(null,s))}},"assert"]],c=0;c<l.length;c++){var d=l[c],p=d[0],_=d[1];u[_]||(u[_]=p)}e.exports=u},330:(e,s,t)=>{const r=t(860),o=r();o.use(r.json()),o.use(r.urlencoded({extended:!1})),e.exports=o},565:e=>{e.exports=function(e,s,t,r){200==t?e.status(t).send({code:t,data:s,message:r||"success"}):e.status(t).send({code:t,data:s,message:r||"failure"})}},270:(e,s,t)=>{const r=t(744);t(788);const o=r.createPool({host:"localhost",user:"root",password:"Zl739#*n!m96",database:"test",port:3306,timezone:"+08:00",connectionLimit:10});e.exports=function(e){return new Promise(((s,t)=>{o.getConnection(((r,o)=>{r&&t(r),o.query(e,(function(e,r,n){o.release(),e&&t(e),s(r,n)}))}))}))}},788:(e,s,t)=>{const r=new(t(495))({host:"127.0.0.1",port:6379,password:"",username:""});e.exports=r},31:(e,s,t)=>{const r=t(744),o={sys_user:{selectUserVo:"\n        select  u.user_id, u.dept_id, u.login_name, u.user_name, u.user_type, u.email, u.avatar, u.phonenumber, u.sex, u.password, u.salt, u.status, u.del_flag, u.login_ip, u.login_date, u.pwd_update_date, u.create_time, u.remark,\n       \t\t    d.dept_id, d.parent_id, d.ancestors, d.dept_name, d.order_num, d.leader, d.status as dept_status,\n       \t\t    r.role_id, r.role_name, r.role_key, r.role_sort, r.data_scope, r.status as role_status\n\t\tfrom sys_user u\n\t\t\t left join sys_dept d on u.dept_id = d.dept_id\n\t\t\t left join sys_user_role ur on u.user_id = ur.user_id\n\t\t\t left join sys_role r on r.role_id = ur.role_id",selectUserByLoginName(e){return r.format(`${this.selectUserVo} where u.login_name = ? and u.del_flag = '0'`,e)},selectUserByPhoneNumber(e){return r.format(`${this.selectUserVo} where u.phonenumber = ? and u.del_flag = '0'`,e)},selectUserByEmail(e){return r.format(`${this.selectUserVo} where u.email = ? and u.del_flag = '0'`,e)},selectUserById(e){return r.format(`${this.selectUserVo} where u.user_id = ?`,e)},selectUserList(e){let s="\n            select u.user_id, u.dept_id, u.login_name, u.user_name, u.user_type, u.email, u.avatar, u.phonenumber, u.password, u.sex, u.salt, u.status, u.del_flag, u.login_ip, u.login_date, u.create_by, u.create_time, u.remark, d.dept_name, d.leader from sys_user u\n            left join sys_dept d on u.dept_id = d.dept_id\n            where u.del_flag = '0'";e.userId&&(s+=` AND u.user_id = ${r.escape(e.userId)}`),e.loginName&&(s+=` AND u.login_name like concat('%', ${r.escape(e.loginName)}, '%')`),e.status&&(s+=` AND u.status = ${r.escape(e.status)}`),e.phonenumber&&(s+=` AND u.phonenumber like concat('%', ${r.escape(e.phonenumber)}, '%')`),e.deptId&&(s+=` AND (u.dept_id = ${r.escape(e.phonenumber)} OR u.dept_id IN ( SELECT t.dept_id FROM sys_dept t WHERE FIND_IN_SET (${r.escape(e.phonenumber)},ancestors) ))`)}},sys_dept:{checkDeptExistUser:e=>r.format("select count(1) from sys_user where dept_id = ? and del_flag = '0'",e)},sys_post:{selectPostsByUserId:e=>r.format("SELECT p.post_id, p.post_name, p.post_code\n            FROM sys_user u\n                 LEFT JOIN sys_user_post up ON u.user_id = up.user_id\n                 LEFT JOIN sys_post p ON up.post_id = p.post_id\n            WHERE up.user_id = ?",e)},sys_role:{selectRoleContactVo:"\n        select distinct r.role_id, r.role_name, r.role_key, r.role_sort, r.data_scope,\n            r.status, r.del_flag, r.create_time, r.remark \n        from sys_role r\n            left join sys_user_role ur on ur.role_id = r.role_id\n            left join sys_user u on u.user_id = ur.user_id\n            left join sys_dept d on u.dept_id = d.dept_id",selectRoleList(e){}}};e.exports=o},225:(e,s,t)=>{t(544),t(421),t(963),t(788),t(254),t(806)},544:(e,s,t)=>{const r=t(710);t(330).use(r("inM2trj8WnxV9dEA"))},963:(e,s,t)=>{const{expressjwt:r}=t(779),o=t(330),n=t(565),{getRedis:u,timeSetRedis:a}=t(833);o.use(r({secret:"9rtdovKLjRyB7wGx",algorithms:["HS256"]}).unless({path:["/login","/captchaImage"]})),o.use((async(e,s,t,r)=>{if("UnauthorizedError"===e.name)return n(t,null,401,"token失效");const o=(s.headers.authorization||"").slice(-5);return o?await u(o)?(a(o,"1800"),void r()):n(t,null,401,"token失效"):n(t,null,401,"无效token")}))},806:(e,s,t)=>{const r=t(931);t(330).use((function(e,s,t){t(r(404))}))},421:(e,s,t)=>{const r=t(470);t(330).use(r("dev"))},198:(e,s,t)=>{const r=t(860).Router(),o=t(669),n=t(565),u={size:4,ignoreChars:"Ooi1lvuI",noise:4,color:!0};r.get("/captchaImage",(async function(e,s,t){const r=o.create(u),a=r.text.toLowerCase();s.cookie("sca",a,{maxAge:6e5,signed:!0,path:"/",httpOnly:!0}),n(s,r.data,200)})),e.exports=r},10:(e,s,t)=>{const r=t(198);t(330).use(r)},254:(e,s,t)=>{t(903),t(10),t(475)},475:(e,s,t)=>{const r=t(146);t(330).use(r)},146:(e,s,t)=>{const r=t(860).Router(),{setRedis:o}=t(833),n=t(565),{setToken:u}=t(317),a=t(31),i=t(270),l=t(490);r.post("/login",(function(e,s,t){const r=e.signedCookies.sca;if(!r)return n(s,null,401,"验证码过期");if(r!=e.body.captcha.toLowerCase())return n(s,null,200,"验证码错误");s.cookie("sca",null,{maxAge:0});const c=e.body.username,d=e.body.password;i(a.sys_user.selectUserByLoginName([c])).then((async e=>{if(0==e.length)return n(s,null,200,"用户不存在");const t=e[0];if(t.password===l(c+d+t.salt+"private")){const e=await u(c,d),t=e.slice(-5);return o(t,{},"1800"),n(s,e,200)}n(s,null,200,"密码错误")}))})),e.exports=r},903:(e,s,t)=>{const r=t(644);t(330).use(r)},644:(e,s,t)=>{const r=t(860),o=t(270),n=r.Router(),u=t(31);n.get("/users",(function(e,s,t){o(u.sys_user.selectUserByLoginName(["ry"])).then((e=>{s.send({code:200,data:e,message:"成功"})}))})),e.exports=n},317:(e,s,t)=>{const r=t(344);s.setToken=function(e,s){return new Promise(((t,o)=>{t("Bearer "+r.sign({username:e,password:s},"9rtdovKLjRyB7wGx"))}))}},833:(e,s,t)=>{const r=t(788);e.exports={setRedis:async function(e,s,t){const o=JSON.stringify(s);await r.set(e,o,((s,o)=>(t&&r.expire(e,t),s?Promise.reject(s):Promise.resolve(o))))},getRedis:async function(e){const s=await r.get(e);return null===s?null:JSON.parse(s)},queryRedis:async function(e){const s=await r.exists(e);return 0===s?null:s},timeSetRedis:async function(e,s){const t=await r.expire(e,s);return 0===t?null:t},hasKeyInRedis:async function(e){const s=await r.exists(e);return 0===s?null:s}}},710:e=>{"use strict";e.exports=require("cookie-parser")},860:e=>{"use strict";e.exports=require("express")},779:e=>{"use strict";e.exports=require("express-jwt")},931:e=>{"use strict";e.exports=require("http-errors")},495:e=>{"use strict";e.exports=require("ioredis")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},490:e=>{"use strict";e.exports=require("md5")},470:e=>{"use strict";e.exports=require("morgan")},744:e=>{"use strict";e.exports=require("mysql")},669:e=>{"use strict";e.exports=require("svg-captcha")},491:e=>{"use strict";e.exports=require("assert")},685:e=>{"use strict";e.exports=require("http")},837:e=>{"use strict";e.exports=require("util")}},s={};function t(r){var o=s[r];if(void 0!==o)return o.exports;var n=s[r]={exports:{}};return e[r](n,n.exports,t),n.exports}(()=>{var e=t(500);t(225);const s=t(330),r=t(685).createServer(s),o="127.0.0.1",n="8001";r.listen(n,o,(()=>{e.log(`server running @ http://${o}:${n}`)}))})()})();